<script>
const sessionId: string =
  sessionStorage.getItem("vicitales_session") ||
  crypto.randomUUID();

sessionStorage.setItem("vicitales_session", sessionId);

let maxScroll = 0;
let sendTimer: NodeJS.Timeout | null = null;

// -----------------------------
// Calculate scroll depth
// -----------------------------
function calculateScroll() {
  const scrollPercent =
    (window.scrollY + window.innerHeight) /
    document.documentElement.scrollHeight;

  const percent = Math.min(100, Math.round(scrollPercent * 100));
  maxScroll = Math.max(maxScroll, percent);
}

// -----------------------------
// Send analytics event
// -----------------------------
function sendVisit() {
  navigator.sendBeacon(
    "/api/visits",
    JSON.stringify({
      path: location.pathname,
      sessionId,
      scrollDepth: maxScroll
    })
  );
}

// -----------------------------
// Scroll listener (throttled)
// -----------------------------
window.addEventListener("scroll", () => {
  calculateScroll();
  // send update after user pauses scrolling
  clearTimeout(sendTimer!);
  sendTimer = setTimeout(sendVisit, 1500);
});

// -----------------------------
// Page navigation (Astro)
// -----------------------------
document.addEventListener("astro:page-load", () => {
  maxScroll = 0;
  sendVisit();
});

// -----------------------------
// Leaving page
// -----------------------------
window.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    sendVisit();
  }
});
</script>
